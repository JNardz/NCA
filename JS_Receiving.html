<script>
    /* ==================================================
       RECEIVING LOGIC
       ================================================== */

    let ALL_CONSIGNORS = [];
    let CART_ITEMS = [];
    let LAST_INTAKE_DATA = null;
    let LAST_RECEIPT_SHEET = null;
    let activeSlot = 0;

    // --- SIGNATURE PAD LOGIC ---
    let isDrawing = false;
    let sigCanvas, sigCtx;

    function initSignatureCanvas() {
        sigCanvas = document.getElementById('sig-canvas');
        const container = sigCanvas.parentElement;

        sigCanvas.width = container.offsetWidth;
        sigCanvas.height = container.offsetHeight;

        sigCtx = sigCanvas.getContext('2d');
        sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
        sigCtx.strokeStyle = "#000";
        sigCtx.lineWidth = 2;
        sigCtx.lineJoin = "round";

        sigCanvas.onmousedown = function (e) { startDraw(e); };
        sigCanvas.onmousemove = function (e) { draw(e); };
        sigCanvas.onmouseup = function () { stopDraw(); };
        sigCanvas.onmouseout = function () { stopDraw(); };

        sigCanvas.ontouchstart = function (e) { e.preventDefault(); startDraw(e.touches[0]); };
        sigCanvas.ontouchmove = function (e) { e.preventDefault(); draw(e.touches[0]); };
        sigCanvas.ontouchend = function () { stopDraw(); };
    }

    function startDraw(e) {
        isDrawing = true;
        const rect = sigCanvas.getBoundingClientRect();
        sigCtx.beginPath();
        sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = sigCanvas.getBoundingClientRect();
        sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        sigCtx.stroke();
    }

    function stopDraw() { isDrawing = false; }
    function clearSignature() { if (sigCtx && sigCanvas) sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height); }

    // --- MAIN LOGIC ---

    function openReceiving() {
        openApp('view-receiving');
        resetIntakeFormState();
        loadAuctionSelect();
        google.script.run.withSuccessHandler(json => ALL_CONSIGNORS = JSON.parse(json)).getAllConsignors();
    }

    function loadAuctionSelect() {
        const sel = document.getElementById('in_target_auction');
        sel.innerHTML = "<option value='' disabled>Loading...</option>";
        google.script.run.withSuccessHandler(json => {
            const auctions = JSON.parse(json);
            const openAuctions = auctions.filter(a => String(a.status).toLowerCase() === 'open' || String(a.status).toLowerCase() === 'active');
            sel.innerHTML = "<option value='' disabled selected>Select Auction...</option>";
            openAuctions.forEach(a => {
                sel.innerHTML += `<option value="${a.id}">${a.name} (${a.id})</option>`;
            });
            if (CURRENT_USER && CURRENT_USER.lastAuction) {
                const exists = openAuctions.find(a => String(a.id) === String(CURRENT_USER.lastAuction));
                if (exists) {
                    sel.value = CURRENT_USER.lastAuction;
                }
            }
            sel.onchange = function () {
                if (CURRENT_USER) {
                    CURRENT_USER.lastAuction = this.value;
                    google.script.run.updateUserAuctionPref(CURRENT_USER.username, this.value);
                }
            };
        }).getAllAuctions();
    }

    function resetIntakeFormState() {
        document.getElementById('in_cid').value = "";
        document.getElementById('in_selected_name').value = "";
        document.getElementById('in_biz_hidden').value = "";
        document.getElementById('in_search').value = "";
        document.getElementById('in_phone_hidden').value = "";
        document.getElementById('in_addr_hidden').value = "";
        document.getElementById('consignor-results').style.display = 'none';
        document.getElementById('consignor-display-card').style.display = 'none';
        if (document.getElementById('sign_name_input')) document.getElementById('sign_name_input').value = "";
        clearSignature();
        CART_ITEMS = [];
        renderCart();
        clearCartForm();
        goToStep1();
    }

    function goToStep1() {
        switchStep('rx-step-1');
        updateBreadcrumbs([{ name: "Receiving", func: "openReceiving()" }, { name: "Identify Consignor", func: null }]);
    }

    function goToStep2() {
        switchStep('rx-step-2');
        const name = document.getElementById('in_selected_name').value;
        const biz = document.getElementById('in_biz_hidden').value;
        const id = document.getElementById('in_cid').value;
        let display = "";
        if (biz && name) display = `${biz} / ${name}`;
        else display = biz || name;
        document.getElementById('summ-con-name').innerHTML = `Consignor: <span class="w3-tag w3-tiny w3-custom-accent" style="margin-right:5px">${id}</span><b>${display}</b>`;
        updateBreadcrumbs([{ name: "Receiving", func: "openReceiving()" }, { name: "Identify Consignor", func: "goToStep1()" }, { name: "Build Inventory", func: null }]);
    }

    function switchStep(stepId) {
        document.querySelectorAll('.intake-step').forEach(el => el.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');
        if (stepId === 'rx-step-3') { setTimeout(initSignatureCanvas, 100); }
    }

    function filterConsignors() {
        const inputVal = document.getElementById('in_search').value.toLowerCase();
        const isNumber = /^\d+$/.test(inputVal);
        if (inputVal.length < 2 && !isNumber) {
            document.getElementById('consignor-results').style.display = 'none';
            return;
        }
        const matches = ALL_CONSIGNORS.filter(c => {
            const term = inputVal;
            const termDigits = term.replace(/\D/g, '');
            const phoneMatch = (termDigits.length > 0) && String(c.phone).replace(/\D/g, '').includes(termDigits);
            return (String(c.id).includes(term) || String(c.name).toLowerCase().includes(term) || String(c.business || "").toLowerCase().includes(term) || phoneMatch || String(c.email || "").toLowerCase().includes(term) || String(c.address).toLowerCase().includes(term));
        });
        renderConsignors(matches);
    }

    function renderConsignors(list) {
        const container = document.getElementById('consignor-results');
        container.innerHTML = "";
        if (list.length === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';
        list.forEach(c => {
            const div = document.createElement('div');
            div.className = "result-row";
            div.onclick = () => { selectConsignor(c); };
            let dispName = c.name;
            if (c.business) {
                if (c.name) dispName = `${c.business} / ${c.name}`;
                else dispName = c.business;
            }
            const idBadge = `<span class="w3-tag w3-tiny w3-text-custom-accent" style="margin-right:8px">${c.id}</span>`;
            div.innerHTML = `<div class="result-main">${idBadge}${dispName}</div><div class="result-sub">${c.phone} | ${c.address}</div>`;
            container.appendChild(div);
        });
    }

    function selectConsignor(c) {
        document.getElementById('in_cid').value = c.id;
        document.getElementById('in_selected_name').value = c.name;
        document.getElementById('in_biz_hidden').value = c.business || ""; 
        document.getElementById('in_phone_hidden').value = c.phone;
        document.getElementById('in_addr_hidden').value = c.address;
        document.getElementById('disp_c_id').innerText = c.id;
        document.getElementById('disp_c_name').innerText = c.name;
        document.getElementById('disp_c_biz').innerText = c.business || "N/A";
        document.getElementById('disp_c_phone').innerText = c.phone;
        document.getElementById('disp_c_addr').innerText = c.address;
        document.getElementById('consignor-results').style.display = 'none';
        document.getElementById('in_search').value = "";
        document.getElementById('consignor-display-card').style.display = 'block';
        document.getElementById('btn-next').classList.remove('w3-disabled');
        document.getElementById('btn-next').disabled = false;
    }

    function handleIdInput(el) {
        const val = el.value.replace(/\D/g, '');
        if (val.length < 1) {
            document.getElementById('consignor-results').style.display = 'none';
            return;
        }
        const matches = ALL_CONSIGNORS.filter(c => String(c.id).includes(val));
        renderConsignors(matches);
    }

    function addToCart() {
        const desc = document.getElementById('cart_desc').value;
        const vin = document.getElementById('cart_vin').value;
        const title = document.getElementById('cart_title').value; // Now retrieves from Select
        const reserve = document.getElementById('cart_reserve').value;
        const note = document.getElementById('cart_note').value;
        const img1 = document.getElementById('url-1').value;
        const img2 = document.getElementById('url-2').value;
        const img3 = document.getElementById('url-3').value;

        if (!desc) {
            showModal("Validation", "Item Name is required.");
            return;
        }

        const item = {
            lotType: "Item", // Generic type
            year: "",
            make: "",
            model: "",
            vin: vin,
            title: title,
            reserve: reserve,
            desc: desc,
            notes: note,
            color: "",
            img1: img1,
            img2: img2,
            img3: img3,
            tasks: []
        };
        CART_ITEMS.push(item);
        renderCart();
        clearCartForm();
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        list.innerHTML = "";
        document.getElementById('cart-count').innerText = CART_ITEMS.length + " Items";
        if (CART_ITEMS.length === 0) {
            list.innerHTML = "<div class='w3-center w3-text-grey w3-padding'>No items added yet.</div>";
            return;
        }
        CART_ITEMS.forEach((item, idx) => {
            const fullTitle = getLotTitle(item);
            const div = document.createElement('div');
            div.className = `cart-item`;
            div.innerHTML = `<div style="display:flex;align-items:center"><div><div style="font-weight:bold">${fullTitle}</div><small class="w3-text-grey">Title: ${item.title || "N/A"} | ${item.notes || ""}</small></div></div><div class="cart-actions"><i class="fa fa-trash cart-del" onclick="removeCartItem(${idx})"></i></div>`;
            list.appendChild(div);
        });
    }

    function removeCartItem(idx) {
        showModal("Confirm Delete", "Remove this item from the list?", function () {
            CART_ITEMS.splice(idx, 1);
            renderCart();
        });
    }

    function clearCartForm() {
        ['cart_desc', 'cart_vin', 'cart_reserve', 'cart_note', 'url-1', 'url-2', 'url-3'].forEach(id => document.getElementById(id).value = "");
        // Reset Dropdown to default
        document.getElementById('cart_title').value = "N/A"; 
        
        [1, 2, 3].forEach(i => {
            document.getElementById('prev-' + i).style.display = 'none';
            document.getElementById('prev-' + i).src = "";
        });
    }

    function submitIntake() {
        const btn = document.getElementById('btn-submit-intake');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;
        const aucId = document.getElementById('in_target_auction').value;
        if (!aucId) {
            showModal("Validation", "Please select a Target Auction.");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        const consignorName = document.getElementById('in_selected_name').value || document.getElementById('in_biz_hidden').value;

        const data = {
            consignorId: document.getElementById('in_cid').value,
            name: consignorName,
            business: document.getElementById('in_biz_hidden').value,
            phone: document.getElementById('in_phone_hidden').value,
            address: document.getElementById('in_addr_hidden').value,
            items: CART_ITEMS,
            user: CURRENT_USER ? CURRENT_USER.username : "Intake",
            auctionId: aucId
        };

        if (!data.name || data.items.length === 0) {
            showModal("Incomplete", "Enter Consignor and Items.");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }
        google.script.run.withSuccessHandler(res => {
            btn.innerText = originalText;
            btn.disabled = false;
            if (res.success) {
                LAST_INTAKE_DATA = res.receiptData;
                switchStep('rx-step-3');
                updateBreadcrumbs([{
                    name: "Receiving",
                    func: "openReceiving()"
                }, {
                    name: "Receipt",
                    func: null
                }]);
            } else {
                showModal("Error", res.message);
            }
        }).withFailureHandler(e => {
            showModal("Error", e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }).processIntakeForm(data);
    }

    function printReceipt() {
        const signName = document.getElementById('sign_name_input').value;
        if (!signName) {
            showModal("Signature Required", "Please enter the printed name of the signer.");
            return;
        }
        let sigData = null;
        if (sigCanvas) {
            sigData = sigCanvas.toDataURL("image/png");
        }
        if (!LAST_INTAKE_DATA) return;
        LAST_INTAKE_DATA.signatureName = signName;
        LAST_INTAKE_DATA.signatureImage = sigData;

        const newWindow = window.open('', '_blank');
        if (newWindow) newWindow.document.write('<html><head><title>Generating Receipt...</title></head><body style="font-family:sans-serif;text-align:center;padding-top:50px;"><h3>Generating PDF...</h3><p>Please wait while we create your receipt.</p></body></html>');

        document.getElementById('print-loading').style.display = 'block';

        google.script.run.withSuccessHandler(res => {
            document.getElementById('print-loading').style.display = 'none';
            LAST_RECEIPT_SHEET = res.sheetName;
            if (newWindow) newWindow.location.href = res.url;
            else window.open(res.url, '_blank');
        }).withFailureHandler(e => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.close();
            showModal("Error", "Failed: " + e.message);
        }).createReceiptSheet(LAST_INTAKE_DATA);
    }

    function printBatchLabels() {
        if (!LAST_INTAKE_DATA || !LAST_INTAKE_DATA.items) return;
        const generatedIds = LAST_INTAKE_DATA.items.map(i => i.generatedId);
        if (generatedIds.length === 0) return;
        const newWindow = window.open('', '_blank');
        if (newWindow) newWindow.document.write('<html><head><title>Generating Labels...</title></head><body style="font-family:sans-serif;text-align:center;padding-top:50px;"><h3>Generating Labels...</h3><p>Please wait...</p></body></html>');
        document.getElementById('print-loading').style.display = 'block';
        google.script.run.withSuccessHandler(res => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.location.href = res.url;
            else window.open(res.url, '_blank');
            setTimeout(() => {
                google.script.run.deleteReceiptSheet(res.sheetName);
            }, 60000);
        }).withFailureHandler(e => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.close();
            showModal("Error", "Failed: " + e.message);
        }).createLabelSheet(generatedIds);
    }

    function finishIntake() {
        if (LAST_RECEIPT_SHEET) {
            google.script.run.deleteReceiptSheet(LAST_RECEIPT_SHEET);
            LAST_RECEIPT_SHEET = null;
        }
        LAST_INTAKE_DATA = null;
        resetIntakeFormState();
        goHome();
    }

    function triggerUpload(slotIdx) {
        activeSlot = slotIdx;
        document.getElementById('upload-input').click();
    }

    function processUpload() {
        const file = document.getElementById('upload-input').files[0];
        if (!file) return;
        const sq = document.getElementById('sq-' + activeSlot);
        sq.classList.add('loading');
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('prev-' + activeSlot).src = e.target.result;
            document.getElementById('prev-' + activeSlot).style.display = 'block';
            const base64 = e.target.result;
            google.script.run.withSuccessHandler(url => {
                sq.classList.remove('loading');
                if (url.startsWith("ERROR")) {
                    showModal("Upload Error", url);
                    return;
                }
                document.getElementById('url-' + activeSlot).value = url;
            }).withFailureHandler(err => {
                sq.classList.remove('loading');
                showModal("Upload Error", "Failed");
            }).uploadIntakeImage(base64);
        };
        reader.readAsDataURL(file);
        document.getElementById('upload-input').value = "";
    }
</script>

<div id="dynamic-intake-fields" style="display:block">
    <label class="w3-text-custom-accent"><b>Item Details</b></label>

    <div class="w3-row-padding w3-margin-top">
        <div class="w3-col m8">
            <label>Item Name</label>
            <input id="cart_desc" class="w3-input w3-border w3-white" placeholder="e.g. 2015 Ford F-150">
        </div>
        <div class="w3-col m4">
            <label>VIN / SN</label>
            <input id="cart_vin" class="w3-input w3-border w3-white" placeholder="...">
        </div>
    </div>

    <div class="w3-row-padding w3-margin-top">
        <div class="w3-col m4">
            <label>Title Status</label>
            <select id="cart_title" class="w3-select w3-border w3-white">
                <option value="N/A" selected>N/A</option>
                <option value="Here">Here</option>
                <option value="Copy">Copy</option>
                <option value="Missing">Missing</option>
                <option value="Salvage">Salvage</option>
            </select>
        </div>
        <div class="w3-col m3">
            <label>Reserve ($)</label>
            <input id="cart_reserve" class="w3-input w3-border w3-white" type="number" placeholder="0.00">
        </div>
        <div class="w3-col m5">
            <label>Notes</label>
            <input id="cart_note" class="w3-input w3-border w3-white" placeholder="Runs and drives...">
        </div>
    </div>

    ```

### 3. Update `IntakeBackend.gs`
I updated `createReceiptSheet` to:
1.  Fetch the `IMAGES_TO_USE` sheet.
2.  Copy this sheet into the temporary spreadsheet so images can be transferred via `copyTo()`.
3.  Check the `item.title` (e.g., "Here", "Copy") and copy the corresponding image cell (A1, A2, etc.) into the receipt.

```javascript
/* ==================================================
   INTAKE PROCESS (SAVE & GENERATE RECEIPT)
   ================================================== */
function processIntakeForm(formData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dbInv = ss.getSheetByName(CONFIG.SHEETS.DB_INV);
  
  try {
    if (!formData.consignorId || !formData.name) throw new Error("Consignor is required.");
    if (!formData.auctionId) throw new Error("Target Auction is required.");
    
    const currentAuction = formData.auctionId;
    let newRows = [];
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "MM/dd/yyyy");

    const existingIds = new Set(dbInv.getDataRange().getValues().map(r => String(r[0])));
    
    formData.items.forEach(item => {
      const primaryImage = item.img1 || item.img2 || item.img3 || "";
      let noteText = item.notes || "";
      
      const initialNotes = [
         {text: "CREATED [SYSTEM]", time: timestamp, user: formData.user || "Intake"}
      ];
      if(noteText) initialNotes.push({text: noteText, time: timestamp, user: formData.user || "Intake"});

      let invId;
      do { invId = Math.floor(Math.random() * 90000000) + 10000000; } while (existingIds.has(String(invId)));
      existingIds.add(String(invId));
      
      item.generatedId = invId; 

      const lotNumber = ""; 
      
      newRows.push([
        invId, currentAuction, formData.consignorId, "", item.year, item.make, item.model, item.vin, "", 
        item.desc, item.title, "", item.reserve, 
        "", primaryImage, 
        JSON.stringify(initialNotes), "Active", timestamp, lotNumber, item.lotType
      ]);
    });
    
    if (newRows.length > 0) {
      dbInv.getRange(dbInv.getLastRow() + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
    } else {
      return { success: false, message: "No items added." };
    }

    return { 
      success: true, 
      message: `Saved ${newRows.length} items to Auction ${currentAuction}.`,
      receiptData: formData 
    };
  } catch (err) {
    return { success: false, message: "Database Error: " + err.message };
  }
}

function addImagesToLot(lotId, newUrls) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dbInv = ss.getSheetByName(CONFIG.SHEETS.DB_INV);
  const data = dbInv.getDataRange().getValues();
  
  for (let i = 0; i < data.length; i++) {
    if (String(data[i][0]) === String(lotId)) {
      const currentImagesStr = String(data[i][14] || "");
      let imageList = currentImagesStr ? currentImagesStr.split(',') : [];
      if (Array.isArray(newUrls)) {
        imageList = imageList.concat(newUrls);
      } else if (newUrls) {
        imageList.push(newUrls);
      }
      imageList = [...new Set(imageList.filter(url => url && url.trim() !== ""))];
      dbInv.getRange(i + 1, 15).setValue(imageList.join(','));
      return "Images Saved";
    }
  }
  throw new Error("Lot not found");
}

/* ==================================================
   RECEIPT GENERATION (Merch_Receipt_Template)
   ================================================== */
function createReceiptSheet(data) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const template = ss.getSheetByName(CONFIG.SHEETS.TEMPLATE_RECEIPT);
  // NEW: Get the source of the images
  const imgSourceSheet = ss.getSheetByName(CONFIG.SHEETS.TEMPLATE_IMAGES); // "IMAGES_TO_USE"
  
  if (!template) throw new Error("Template sheet '" + CONFIG.SHEETS.TEMPLATE_RECEIPT + "' is missing.");
  if (!imgSourceSheet) throw new Error("Image Source sheet '" + CONFIG.SHEETS.TEMPLATE_IMAGES + "' is missing.");

  // 1. Prepare Data
  const timestamp = new Date().getTime();
  const currentDate = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "MM/dd/yyyy");
  
  let headerName = data.name || "";
  if (data.business && data.business.trim() !== "") {
    if (data.name && data.name.trim() !== "" && data.name !== data.business) {
      headerName = `${data.business}/${data.name}`;
    } else {
      headerName = data.business;
    }
  }

  const ITEM_ROWS = [8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32];
  const ITEMS_PER_PAGE = ITEM_ROWS.length; // 13 items

  // 2. Chunk Items into Pages
  const items = data.items || [];
  let pages = [];
  for (let i = 0; i < items.length; i += ITEMS_PER_PAGE) {
    pages.push(items.slice(i, i + ITEMS_PER_PAGE));
  }
  if (pages.length === 0) pages.push([]); 

  // 3. Create Temporary Spreadsheet
  const tempSpreadsheet = SpreadsheetApp.create("Temp_Receipt_" + data.consignorId);
  const tempId = tempSpreadsheet.getId();
  
  try {
    // NEW: Copy the Image Source sheet to the temp spreadsheet so we can use copyTo()
    const tempImgSheet = imgSourceSheet.copyTo(tempSpreadsheet).setName("Temp_Images_Source");

    pages.forEach((pageItems, pageIndex) => {
      const sheetName = `Page_${pageIndex + 1}`;
      const newSheet = template.copyTo(tempSpreadsheet).setName(sheetName);
      
      newSheet.setHiddenGridlines(true);

      // --- HEADER ---
      newSheet.getRange("B2").setValue("C-" + data.consignorId);
      newSheet.getRange("B3").setValue(headerName);
      
      if (data.address && data.address.trim() !== "") {
        newSheet.getRange("B4").setValue(data.address);
        newSheet.getRange("B5").setValue(data.phone || "");
      } else {
        newSheet.getRange("B4").setValue(data.phone || "");
        newSheet.getRange("B5").clearContent();
      }
      
      newSheet.getRange("E5").setValue(currentDate);

      // --- ITEMS ---
      ITEM_ROWS.forEach((r, idx) => {
        const item = pageItems[idx];
        if (item) {
          // A: Title - NOW IMAGE LOGIC
          // Clear text first
          newSheet.getRange(r, 1).clearContent();
          
          let sourceRange = null;
          // Mapping: Here->A1, Copy->A2, Salvage->A3, Missing->A4
          if (item.title === "Here") sourceRange = tempImgSheet.getRange("A1");
          else if (item.title === "Copy") sourceRange = tempImgSheet.getRange("A2");
          else if (item.title === "Salvage") sourceRange = tempImgSheet.getRange("A3");
          else if (item.title === "Missing") sourceRange = tempImgSheet.getRange("A4");
          
          if (sourceRange) {
             // Copy image/cell from temp source to receipt cell
             sourceRange.copyTo(newSheet.getRange(r, 1));
          } else {
             // N/A or others: leave blank
             newSheet.getRange(r, 1).clearContent();
          }

          // B: Inv ID
          newSheet.getRange(r, 2).setValue("#" + item.generatedId);
          // C: Item Name
          newSheet.getRange(r, 3).setValue(item.desc || "");
          // D: VIN
          newSheet.getRange(r, 4).setValue(item.vin || ""); 
          // E: Reserve
          newSheet.getRange(r, 5).setValue(item.reserve || "");
        } else {
          // Clear unused row and the row below it
          newSheet.getRange(r, 1, 1, 5).clearContent();     
          if (r + 1 <= newSheet.getMaxRows()) {
             newSheet.getRange(r + 1, 1, 1, 5).clearContent(); 
          }
        }
      });

      // --- FOOTER & SIGNATURE ---
      newSheet.getRange("A38").setValue(data.user || "");
      newSheet.getRange("C38").setValue(data.signatureName || "");
      
      newSheet.getRange("D36").clearContent();
      if (data.signatureImage) {
        try {
          var base64 = data.signatureImage.split(',')[1];
          var decoded = Utilities.base64Decode(base64);
          var blob = Utilities.newBlob(decoded, 'image/png', 'signature.png');
          var sigImg = newSheet.insertImage(blob, 4, 36, 0, 20);
          sigImg.setWidth(250).setHeight(60);
        } catch (e) {
          console.error("Sig Error", e);
        }
      }

      newSheet.getRange("E41").setValue(`Page ${pageIndex + 1}/${pages.length}`);
    });

    const defaultSheet = tempSpreadsheet.getSheetByName("Sheet1");
    if (defaultSheet) tempSpreadsheet.deleteSheet(defaultSheet);
    
    // Cleanup the temp image source sheet before printing
    const tempImgSheetRef = tempSpreadsheet.getSheetByName("Temp_Images_Source");
    if (tempImgSheetRef) tempSpreadsheet.deleteSheet(tempImgSheetRef);

    SpreadsheetApp.flush();

    // 4. Export PDF
    const exportUrl = "https://docs.google.com/spreadsheets/d/" + tempId + 
      "/export?format=pdf" +
      "&size=letter" +
      "&portrait=true" +
      "&scale=4" +           
      "&gridlines=false" +   
      "&printtitle=false" +
      "&sheetnames=false" +
      "&pagenum=UNDEFINED" +
      "&attachment=false" +
      "&top_margin=0.25" +   
      "&bottom_margin=0.25" +
      "&left_margin=0.25" +
      "&right_margin=0.25";

    const pdfBlob = UrlFetchApp.fetch(exportUrl, {
      headers: { 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() }
    }).getBlob().setName(`Rcpt_${data.consignorId}_${timestamp}.pdf`);

    // 5. Save to Drive
    const folders = DriveApp.getFoldersByName(CONFIG.FOLDER_NAME);
    const folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(CONFIG.FOLDER_NAME);
    folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const file = folder.createFile(pdfBlob);
    const pdfUrl = file.getUrl();

    DriveApp.getFileById(tempId).setTrashed(true);

    const dbRcpt = ss.getSheetByName(CONFIG.SHEETS.DB_RCPT);
    if (dbRcpt) { 
      dbRcpt.appendRow([
        "RCPT-" + timestamp, 
        data.consignorId, 
        currentDate, 
        pdfUrl, 
        file.getName()
      ]);
    }

    return { url: pdfUrl, sheetName: "PDF" };

  } catch (e) {
    try { DriveApp.getFileById(tempId).setTrashed(true); } catch(x) {}
    throw e;
  }
}

function deleteReceiptSheet(sheetName) { 
  return "Cleaned up";
}

function uploadIntakeImage(data) { 
  try { 
    const folders = DriveApp.getFoldersByName(CONFIG.FOLDER_NAME);
    let folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(CONFIG.FOLDER_NAME); 
    folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); 
    const bytes = Utilities.base64Decode(data.substr(data.indexOf('base64,') + 7));
    const blob = Utilities.newBlob(bytes, data.substring(5, data.indexOf(';')), "intake_" + new Date().getTime() + ".jpg"); 
    const file = folder.createFile(blob);
    return "https://drive.google.com/uc?export=view&id=" + file.getId(); 
  } catch (e) { return "ERROR: " + e.toString();
  } 
}
