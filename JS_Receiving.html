<script>
    /* ==================================================
       RECEIVING LOGIC
       ================================================== */

    let ALL_CONSIGNORS = [];
    let CART_ITEMS = [];
    let LAST_INTAKE_DATA = null;
    let LAST_RECEIPT_SHEET = null;
    let activeSlot = 0;

    // --- SIGNATURE PAD LOGIC ---
    let isDrawing = false;
    let sigCanvas, sigCtx;

    function initSignatureCanvas() {
        sigCanvas = document.getElementById('sig-canvas');
        const container = sigCanvas.parentElement;

        // Set canvas resolution to match display size for sharpness and correct coordinates
        sigCanvas.width = container.offsetWidth;
        sigCanvas.height = container.offsetHeight;

        sigCtx = sigCanvas.getContext('2d');

        // Reset Style
        sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
        sigCtx.strokeStyle = "#000";
        sigCtx.lineWidth = 2;
        sigCtx.lineJoin = "round";

        // Mouse Events
        sigCanvas.onmousedown = function (e) { startDraw(e); };
        sigCanvas.onmousemove = function (e) { draw(e); };
        sigCanvas.onmouseup = function () { stopDraw(); };
        sigCanvas.onmouseout = function () { stopDraw(); };

        // Touch Events
        sigCanvas.ontouchstart = function (e) { e.preventDefault(); startDraw(e.touches[0]); };
        sigCanvas.ontouchmove = function (e) { e.preventDefault(); draw(e.touches[0]); };
        sigCanvas.ontouchend = function () { stopDraw(); };
    }

    function startDraw(e) {
        isDrawing = true;
        const rect = sigCanvas.getBoundingClientRect();

        sigCtx.beginPath();
        // Since canvas width/height now match rect width/height, we don't need complex scaling
        sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = sigCanvas.getBoundingClientRect();

        sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        sigCtx.stroke();
    }

    function stopDraw() {
        isDrawing = false;
    }

    function clearSignature() {
        if (sigCtx && sigCanvas) sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    }

    // --- MAIN LOGIC ---

    function openReceiving() {
        openApp('view-receiving');
        resetIntakeFormState();
        loadAuctionSelect();
        google.script.run.withSuccessHandler(json => ALL_CONSIGNORS = JSON.parse(json)).getAllConsignors();
    }

    function loadAuctionSelect() {
        const sel = document.getElementById('in_target_auction');
        sel.innerHTML = "<option value='' disabled>Loading...</option>";
        google.script.run.withSuccessHandler(json => {
            const auctions = JSON.parse(json);
            const openAuctions = auctions.filter(a => String(a.status).toLowerCase() === 'open' || String(a.status).toLowerCase() === 'active');
            sel.innerHTML = "<option value='' disabled selected>Select Auction...</option>";
            openAuctions.forEach(a => {
                sel.innerHTML += `<option value="${a.id}">${a.name} (${a.id})</option>`;
            });
            if (CURRENT_USER && CURRENT_USER.lastAuction) {
                const exists = openAuctions.find(a => String(a.id) === String(CURRENT_USER.lastAuction));
                if (exists) {
                    sel.value = CURRENT_USER.lastAuction;
                }
            }
            sel.onchange = function () {
                if (CURRENT_USER) {
                    CURRENT_USER.lastAuction = this.value;
                    google.script.run.updateUserAuctionPref(CURRENT_USER.username, this.value);
                }
            };
        }).getAllAuctions();
    }

    function resetIntakeFormState() {
        document.getElementById('in_cid').value = "";
        document.getElementById('in_selected_name').value = "";
        document.getElementById('in_biz_hidden').value = "";
        document.getElementById('in_search').value = "";
        document.getElementById('in_phone_hidden').value = "";
        document.getElementById('in_addr_hidden').value = "";
        document.getElementById('consignor-results').style.display = 'none';
        document.getElementById('consignor-display-card').style.display = 'none';

        // Reset Signature
        if (document.getElementById('sign_name_input')) document.getElementById('sign_name_input').value = "";
        clearSignature();

        CART_ITEMS = [];
        renderCart();
        clearCartForm();
        goToStep1();
    }

    function goToStep1() {
        switchStep('rx-step-1');
        updateBreadcrumbs([{
            name: "Receiving",
            func: "openReceiving()"
        }, {
            name: "Identify Consignor",
            func: null
        }]);
    }

    function goToStep2() {
        switchStep('rx-step-2');

        // FORMAT HEADER: [ID] [BUSINESS] / [NAME]
        const name = document.getElementById('in_selected_name').value;
        const biz = document.getElementById('in_biz_hidden').value;
        const id = document.getElementById('in_cid').value;

        let display = "";
        if (biz && name) display = `${biz} / ${name}`;
        else display = biz || name;

        document.getElementById('summ-con-name').innerHTML =
            `Consignor: <span class="w3-tag w3-tiny w3-custom-accent" style="margin-right:5px">${id}</span><b>${display}</b>`;

        updateBreadcrumbs([{
            name: "Receiving",
            func: "openReceiving()"
        }, {
            name: "Identify Consignor",
            func: "goToStep1()"
        }, {
            name: "Build Inventory",
            func: null
        }]);
    }

    function switchStep(stepId) {
        document.querySelectorAll('.intake-step').forEach(el => el.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');

        // Init canvas if entering step 3
        if (stepId === 'rx-step-3') {
            // Slight delay to allow DOM to render and get correct dimensions
            setTimeout(initSignatureCanvas, 100);
        }
    }

    function filterConsignors() {
        const inputVal = document.getElementById('in_search').value.toLowerCase();
        const isNumber = /^\d+$/.test(inputVal);
        if (inputVal.length < 2 && !isNumber) {
            document.getElementById('consignor-results').style.display = 'none';
            return;
        }
        const matches = ALL_CONSIGNORS.filter(c => {
            const term = inputVal;
            const termDigits = term.replace(/\D/g, '');
            const phoneMatch = (termDigits.length > 0) && String(c.phone).replace(/\D/g, '').includes(termDigits);
            return (String(c.id).includes(term) || String(c.name).toLowerCase().includes(term) || String(c.business || "").toLowerCase().includes(term) || phoneMatch || String(c.email || "").toLowerCase().includes(term) || String(c.address).toLowerCase().includes(term));
        });
        renderConsignors(matches);
    }

    function renderConsignors(list) {
        const container = document.getElementById('consignor-results');
        container.innerHTML = "";
        if (list.length === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';
        list.forEach(c => {
            const div = document.createElement('div');
            div.className = "result-row";
            div.onclick = () => {
                selectConsignor(c);
            };

            // Logic for Name Display
            let dispName = c.name;
            if (c.business) {
                if (c.name) dispName = `${c.business} / ${c.name}`;
                else dispName = c.business;
            }

            // ID Badge moved to left
            const idBadge = `<span class="w3-tag w3-tiny w3-text-custom-accent" style="margin-right:8px">${c.id}</span>`;

            div.innerHTML = `<div class="result-main">${idBadge}${dispName}</div><div class="result-sub">${c.phone} | ${c.address}</div>`;
            container.appendChild(div);
        });
    }

    function selectConsignor(c) {
        document.getElementById('in_cid').value = c.id;
        document.getElementById('in_selected_name').value = c.name;
        document.getElementById('in_biz_hidden').value = c.business || ""; // Store Biz Name
        document.getElementById('in_phone_hidden').value = c.phone;
        document.getElementById('in_addr_hidden').value = c.address;
        document.getElementById('disp_c_id').innerText = c.id;
        document.getElementById('disp_c_name').innerText = c.name;
        document.getElementById('disp_c_biz').innerText = c.business || "N/A";
        document.getElementById('disp_c_phone').innerText = c.phone;
        document.getElementById('disp_c_addr').innerText = c.address;
        document.getElementById('consignor-results').style.display = 'none';
        document.getElementById('in_search').value = "";
        document.getElementById('consignor-display-card').style.display = 'block';
        document.getElementById('btn-next').classList.remove('w3-disabled');
        document.getElementById('btn-next').disabled = false;
    }

    function handleIdInput(el) {
        const val = el.value.replace(/\D/g, '');
        if (val.length < 1) {
            document.getElementById('consignor-results').style.display = 'none';
            return;
        }
        const matches = ALL_CONSIGNORS.filter(c => String(c.id).includes(val));
        renderConsignors(matches);
    }

    function addToCart() {
        const desc = document.getElementById('cart_desc').value;
        const vin = document.getElementById('cart_vin').value;
        const title = document.getElementById('cart_title').value;
        const reserve = document.getElementById('cart_reserve').value;
        const note = document.getElementById('cart_note').value;
        const img1 = document.getElementById('url-1').value;
        const img2 = document.getElementById('url-2').value;
        const img3 = document.getElementById('url-3').value;

        if (!desc) {
            showModal("Validation", "Item Name is required.");
            return;
        }

        const item = {
            lotType: "Item", // Generic type
            year: "",
            make: "",
            model: "",
            vin: vin,
            title: title,
            reserve: reserve,
            desc: desc,
            notes: note,
            color: "",
            img1: img1,
            img2: img2,
            img3: img3,
            tasks: []
        };
        CART_ITEMS.push(item);
        renderCart();
        clearCartForm();
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        list.innerHTML = "";
        document.getElementById('cart-count').innerText = CART_ITEMS.length + " Items";
        if (CART_ITEMS.length === 0) {
            list.innerHTML = "<div class='w3-center w3-text-grey w3-padding'>No items added yet.</div>";
            return;
        }
        CART_ITEMS.forEach((item, idx) => {
            const fullTitle = getLotTitle(item);
            // Thumbnails removed
            const div = document.createElement('div');
            div.className = `cart-item`;
            div.innerHTML = `<div style="display:flex;align-items:center"><div><div style="font-weight:bold">${fullTitle}</div><small class="w3-text-grey">${item.notes || ""}</small></div></div><div class="cart-actions"><i class="fa fa-trash cart-del" onclick="removeCartItem(${idx})"></i></div>`;
            list.appendChild(div);
        });
    }

    function removeCartItem(idx) {
        showModal("Confirm Delete", "Remove this item from the list?", function () {
            CART_ITEMS.splice(idx, 1);
            renderCart();
        });
    }

    function clearCartForm() {
        ['cart_desc', 'cart_vin', 'cart_title', 'cart_reserve', 'cart_note', 'url-1', 'url-2', 'url-3'].forEach(id => document.getElementById(id).value = "");
        [1, 2, 3].forEach(i => {
            document.getElementById('prev-' + i).style.display = 'none';
            document.getElementById('prev-' + i).src = "";
        });
    }

    function submitIntake() {
        const btn = document.getElementById('btn-submit-intake');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;
        const aucId = document.getElementById('in_target_auction').value;
        if (!aucId) {
            showModal("Validation", "Please select a Target Auction.");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }

        // FIX: Use Business Name if Personal Name is empty
        const consignorName = document.getElementById('in_selected_name').value || document.getElementById('in_biz_hidden').value;

        const data = {
            consignorId: document.getElementById('in_cid').value,
            name: consignorName,
            phone: document.getElementById('in_phone_hidden').value,
            address: document.getElementById('in_addr_hidden').value,
            items: CART_ITEMS,
            user: CURRENT_USER ? CURRENT_USER.username : "Intake",
            auctionId: aucId
        };

        if (!data.name || data.items.length === 0) {
            showModal("Incomplete", "Enter Consignor and Items.");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
        }
        google.script.run.withSuccessHandler(res => {
            btn.innerText = originalText;
            btn.disabled = false;
            if (res.success) {
                LAST_INTAKE_DATA = res.receiptData;
                switchStep('rx-step-3');
                updateBreadcrumbs([{
                    name: "Receiving",
                    func: "openReceiving()"
                }, {
                    name: "Receipt",
                    func: null
                }]);
            } else {
                showModal("Error", res.message);
            }
        }).withFailureHandler(e => {
            showModal("Error", e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }).processIntakeForm(data);
    }

    function printReceipt() {
        // Validation: Ensure signature and name are provided
        const signName = document.getElementById('sign_name_input').value;
        if (!signName) {
            showModal("Signature Required", "Please enter the printed name of the signer.");
            return;
        }

        // Get signature image data
        let sigData = null;
        if (sigCanvas) {
            sigData = sigCanvas.toDataURL("image/png");
        }

        if (!LAST_INTAKE_DATA) return;

        // Add signature data to the object
        LAST_INTAKE_DATA.signatureName = signName;
        LAST_INTAKE_DATA.signatureImage = sigData;

        const newWindow = window.open('', '_blank');
        if (newWindow) newWindow.document.write('<html><head><title>Generating Receipt...</title></head><body style="font-family:sans-serif;text-align:center;padding-top:50px;"><h3>Generating PDF...</h3><p>Please wait while we create your receipt.</p></body></html>');

        document.getElementById('print-loading').style.display = 'block';

        google.script.run.withSuccessHandler(res => {
            document.getElementById('print-loading').style.display = 'none';
            LAST_RECEIPT_SHEET = res.sheetName;
            if (newWindow) newWindow.location.href = res.url;
            else window.open(res.url, '_blank');
        }).withFailureHandler(e => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.close();
            showModal("Error", "Failed: " + e.message);
        }).createReceiptSheet(LAST_INTAKE_DATA);
    }

    function printBatchLabels() {
        if (!LAST_INTAKE_DATA || !LAST_INTAKE_DATA.items) return;
        const generatedIds = LAST_INTAKE_DATA.items.map(i => i.generatedId);
        if (generatedIds.length === 0) return;
        const newWindow = window.open('', '_blank');
        if (newWindow) newWindow.document.write('<html><head><title>Generating Labels...</title></head><body style="font-family:sans-serif;text-align:center;padding-top:50px;"><h3>Generating Labels...</h3><p>Please wait...</p></body></html>');
        document.getElementById('print-loading').style.display = 'block';
        google.script.run.withSuccessHandler(res => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.location.href = res.url;
            else window.open(res.url, '_blank');
            setTimeout(() => {
                google.script.run.deleteReceiptSheet(res.sheetName);
            }, 60000);
        }).withFailureHandler(e => {
            document.getElementById('print-loading').style.display = 'none';
            if (newWindow) newWindow.close();
            showModal("Error", "Failed: " + e.message);
        }).createLabelSheet(generatedIds);
    }

    function finishIntake() {
        if (LAST_RECEIPT_SHEET) {
            google.script.run.deleteReceiptSheet(LAST_RECEIPT_SHEET);
            LAST_RECEIPT_SHEET = null;
        }
        LAST_INTAKE_DATA = null;
        resetIntakeFormState();
        goHome();
    }

    function triggerUpload(slotIdx) {
        activeSlot = slotIdx;
        document.getElementById('upload-input').click();
    }

    function processUpload() {
        const file = document.getElementById('upload-input').files[0];
        if (!file) return;
        const sq = document.getElementById('sq-' + activeSlot);
        sq.classList.add('loading');
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('prev-' + activeSlot).src = e.target.result;
            document.getElementById('prev-' + activeSlot).style.display = 'block';
            const base64 = e.target.result;
            google.script.run.withSuccessHandler(url => {
                sq.classList.remove('loading');
                if (url.startsWith("ERROR")) {
                    showModal("Upload Error", url);
                    return;
                }
                document.getElementById('url-' + activeSlot).value = url;
            }).withFailureHandler(err => {
                sq.classList.remove('loading');
                showModal("Upload Error", "Failed");
            }).uploadIntakeImage(base64);
        };
        reader.readAsDataURL(file);
        document.getElementById('upload-input').value = "";
    }
</script>